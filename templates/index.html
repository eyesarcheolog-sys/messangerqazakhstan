<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мой Мессенджер</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; height: 100vh; }
        #sidebar { width: 250px; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #user-info { padding: 20px; border-bottom: 1px solid #ddd; }
        #user-info h2 { margin: 0; font-size: 18px; }
        #user-info a { font-size: 14px; color: #0084ff; text-decoration: none; }
        .list-header {
            padding: 10px 20px;
            font-size: 12px;
            font-weight: bold;
            color: #657786;
            text-transform: uppercase;
            background-color: #f5f8fa;
            border-bottom: 1px solid #e6ecf0;
        }
        .chat-list-container { flex-grow: 1; overflow-y: auto; }
        .chat-list { list-style-type: none; padding: 0; margin: 0; }
        .chat-list li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; }
        .chat-list li:hover { background-color: #f5f5f5; }
        .chat-list li.active { background-color: #e0f0ff; }
        .contact-info { display: flex; align-items: center; }
        .online-indicator { width: 10px; height: 10px; background-color: #ccc; border-radius: 50%; transition: background-color 0.3s; margin-right: 10px; }
        .online-indicator.online { background-color: #28a745; }
        .notification-dot { background-color: #dc3545; color: white; border-radius: 50%; font-size: 11px; font-weight: bold; min-width: 20px; height: 20px; display: none; place-content: center; padding: 0 4px; }
        .notification-dot.visible { display: grid; }
        #create-group-btn { margin: 10px; padding: 10px; background-color: #28a745; color: white; text-align: center; border-radius: 5px; cursor: pointer; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-header { padding: 20px; border-bottom: 1px solid #ddd; margin: 0; font-size: 18px; color: #333; }
        #messages { list-style-type: none; margin: 0; padding: 20px; overflow-y: auto; flex-grow: 1; }
        #messages li { padding: 8px 12px; margin-bottom: 10px; border-radius: 18px; width: fit-content; max-width: 70%; display: flex; flex-direction: column; }
        .message-content { display: block; }
        .timestamp { font-size: 11px; color: #888; margin-top: 4px; }
        #messages li.my-message { background-color: #0084ff; color: white; margin-left: auto; align-items: flex-end; }
        #messages li.my-message .timestamp { color: #e0f0ff; }
        #messages li.other-message { background-color: #e4e6eb; color: #050505; align-items: flex-start; }
        #form { display: flex; padding: 20px; border-top: 1px solid #ddd; background-color: #fff; }
        #input { border: 1px solid #ccc; padding: 10px; flex-grow: 1; border-radius: 18px; margin-right: 10px; }
        #form button { background: #0084ff; border: none; padding: 10px 15px; color: white; border-radius: 18px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .members-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="user-info">
            <h2>{{ current_user.username }}</h2>
            <a href="{{ url_for('logout') }}">Выйти</a>
        </div>
        
        <div class="chat-list-container">
            <div class="list-header">Группы</div>
            <ul id="group-list" class="chat-list">
                {% for group in groups %}
                    <li data-id="{{ group.id }}" data-type="group" data-name="{{ group.name }}">
                        <span># {{ group.name }}</span>
                        <span class="notification-dot" id="notif-group-{{ group.id }}"></span>
                    </li>
                {% endfor %}
            </ul>

            <div class="list-header">Личные сообщения</div>
            <ul id="contact-list" class="chat-list">
                {% for user in users %}
                    {% if user.id != current_user.id %}
                        <li data-id="{{ user.id }}" data-type="user" data-name="{{ user.username }}">
                            <div class="contact-info">
                                <span class="online-indicator" id="status-{{ user.username }}"></span>
                                <span>{{ user.username }}</span>
                            </div>
                            <span class="notification-dot" id="notif-{{ user.username }}"></span>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        
        <div id="create-group-btn">Создать группу</div>
    </div>

    <div id="chat-container">
        <h2 id="chat-header">Выберите чат</h2>
        <ul id="messages"></ul>
        <form id="form" action="">
            <input id="input" autocomplete="off" placeholder="Введите сообщение..." />
            <button>Отправить</button>
        </form>
    </div>

    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Создание новой группы</h2>
            <form action="/create_group" method="POST">
                <input type="text" name="group_name" placeholder="Название группы" required>
                <h4>Выберите участников:</h4>
                <div class="members-list">
                    {% for user in users %}
                        {% if user.id != current_user.id %}
                        <div>
                            <input type="checkbox" name="members" value="{{ user.id }}" id="user-{{ user.id }}">
                            <label for="user-{{ user.id }}">{{ user.username }}</label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <button type="submit" style="margin-top: 20px; width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px;">Создать</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const allLists = document.querySelectorAll('.chat-list');
        const username = "{{ current_user.username }}";
        
        let currentChat = { type: null, id: null, name: null };
        const unreadCounts = {};

        function appendMessage(data) {
            const item = document.createElement('li');
            const messageContent = document.createElement('span');
            messageContent.className = 'message-content';
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'timestamp';
            const date = new Date(data.timestamp);
            timestampSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (data.sender === username) {
                messageContent.textContent = `Вы: ${data.message}`;
                item.classList.add('my-message');
            } else {
                if (currentChat.type === 'group') {
                    messageContent.textContent = `${data.sender}: ${data.message}`;
                } else {
                    messageContent.textContent = data.message;
                }
                item.classList.add('other-message');
            }
            item.appendChild(messageContent);
            item.appendChild(timestampSpan);
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        allLists.forEach(list => {
            list.addEventListener('click', function(e) {
                const li = e.target.closest('li');
                if (li) {
                    document.querySelectorAll('.chat-list li').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                    
                    currentChat.type = li.dataset.type;
                    currentChat.id = li.dataset.id;
                    currentChat.name = li.dataset.name;

                    const notifId = currentChat.type === 'user' ? `notif-${currentChat.name}` : `notif-group-${currentChat.id}`;
                    const notifIndicator = document.getElementById(notifId);
                    if (notifIndicator) {
                        notifIndicator.classList.remove('visible');
                    }
                    
                    const countKey = currentChat.type === 'user' ? currentChat.name : currentChat.id;
                    unreadCounts[countKey] = 0;
                    
                    messages.innerHTML = '';
                    const headerText = currentChat.type === 'group' ? currentChat.name : `Чат с ${currentChat.name}`;
                    document.getElementById('chat-header').textContent = headerText;
                    
                    const historyUrl = currentChat.type === 'user' ? `/history/${currentChat.name}` : `/history/group/${currentChat.id}`;
                    fetch(historyUrl)
                        .then(response => response.json())
                        .then(history => {
                            history.forEach(appendMessage);
                        });
                }
            });
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value && currentChat.type) {
                if (currentChat.type === 'user') {
                    socket.emit('private_message', { recipient: currentChat.name, message: input.value });
                } else if (currentChat.type === 'group') {
                    socket.emit('group_message', { group_id: currentChat.id, message: input.value });
                }
                input.value = '';
            } else {
                alert("Пожалуйста, выберите чат для отправки сообщения.");
            }
        });

        socket.on('receive_private_message', function(data) {
            if (currentChat.type === 'user' && (data.sender === currentChat.name || (data.sender === username && data.recipient === currentChat.name))) {
                appendMessage(data);
            }
        });

        socket.on('receive_group_message', function(data) {
            if (currentChat.type === 'group' && data.group_id == currentChat.id) {
                appendMessage(data);
            } else {
                const groupId = data.group_id;
                unreadCounts[groupId] = (unreadCounts[groupId] || 0) + 1;
                const notifIndicator = document.getElementById(`notif-group-${groupId}`);
                if (notifIndicator) {
                    notifIndicator.textContent = unreadCounts[groupId];
                    notifIndicator.classList.add('visible');
                }
            }
        });

        socket.on('update_online_users', function(online_users) {
            document.querySelectorAll('#contact-list li').forEach(li => {
                const contactUsername = li.dataset.name;
                const indicator = document.getElementById(`status-${contactUsername}`);
                if (indicator) {
                    if (online_users.includes(contactUsername)) {
                        indicator.classList.add('online');
                    } else {
                        indicator.classList.remove('online');
                    }
                }
            });
        });

        socket.on('new_message_notification', function(data) {
            if (currentChat.type !== 'user' || data.sender !== currentChat.name) {
                const sender = data.sender;
                unreadCounts[sender] = (unreadCounts[sender] || 0) + 1;
                const notifIndicator = document.getElementById(`notif-${sender}`);
                if (notifIndicator) {
                    notifIndicator.textContent = unreadCounts[sender];
                    notifIndicator.classList.add('visible');
                }
            }
        });

        const modal = document.getElementById('createGroupModal');
        const btn = document.getElementById('create-group-btn');
        const span = document.getElementsByClassName('close-btn')[0];

        btn.onclick = function() {
            modal.style.display = "block";
        }
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>